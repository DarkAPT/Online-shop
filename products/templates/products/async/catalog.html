{% load product_tags %}
{% load static %}

{% for product in products %}
<div class="products" id='filtered-product'>
        <div class="product">
            <div class="product-img">
                <img src="{{ product.image.url }}" alt="" >
            </div>
            <div class="product-info">
                <a href="{% url "catalog:product" product.slug %}">
                    <div class="product-name">
                        <span>{{ product.name|truncatechars:50 }}</span>
                    </div>
                </a>
                {% tag_characteristics_sets as CharacteristicsSet %}
                {% for property in CharacteristicsSet%}
                {% if property.productid.id == product.id and property.propertyid.name != "Кол-во вентиляторов"%}
                <div class="product-param">
                    <div class="p-p">
                        <i>{{ property.propertyid.name }}:</i>
                        <p>{{ property.propertyvalueid.value }}</p>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <div class="product-purchase">
                {% if product.discount != 0%}
                <span class="new-price">{{ product.sell_price }}₽</span> <span class="old-price">{{ product.price_without_disc }}₽</span>
                <a href="#" class="view-more">В корзину</a>
                {% else %}
                <span class="new-price">{{ product.price_without_disc }}₽</span>
                <a href="#" class="view-more">В корзину</a>
                {% endif %}
            </div>
        </div>
</div>
{% endfor %}
<div class="pagination">
    {% if products.paginator.num_pages > 1 %}
        <button class='first_page'>В начало</button>
        <ul>
            {% for page in products.paginator.page_range %}
                {% if page >= products.number|add:"-2" and page <= products.number|add:"2"%}
                    <button type="button" class="page_button" data-page = {{page}} >
                        <li class="link{% if  products.number == page %} active {% endif %}" > {{ page }} </li>
                    </button>
                {% endif %}                 
            {% endfor %}
        </ul>
        <button class='next_page'>Следующая</button>
    {% endif %}
</div>


<script>
    $(document).ready(function(){
        var currentUrl = window.location.href.split('/');
        let query = window.location.href.split('?');
        if (query.length >= 2) {
            category_slug = currentUrl.pop() && currentUrl.pop();
        } else {
            category_slug = currentUrl.pop() || currentUrl.pop();
        }    
        if (query.length > 1 && query[1].split("=")[0] === "q") {
            query = decodeURIComponent(query[1].split("=")[1]); // Декодируем строку
        }
    
    
        let filter_object = {
            'category_slug': category_slug,  // Добавляем category_slug в объект фильтра
            'page': 1,
            'q': query
        };
        $('.first_page').click(function() {
            filter_object.page = 1;
        })
        $('.page_button').click(function() {
            let current_page = $(this).data("page");
            filter_object.page = current_page;
        })
        $('.next_page').click(function() {
            filter_object.page = filter_object.page+1
        })
        $(".page_button, .first_page, .next_page").on("click", function(){

            let max_price = document.querySelector(".input-max").value;
            let min_price = document.querySelector(".input-min").value;
            filter_object.min_price = min_price;
            filter_object.max_price = max_price;
    
            $(".filter-checkbox").each(function(){
                let filter_key = $(this).data("filter")
    
                filter_object[filter_key] = Array.from(document.querySelectorAll('input[data-filter=' + filter_key + ']:checked')).map(function(element) {
                    return element.value
                })
            })
            $.ajax({
                url: '/filter-products',
                data: filter_object,
                dataType: 'json',
                beforeSend: function(){
                },
                success: function (response) {
                    $("#product_page").html(response.data)
                }
            })
        })
    }) 
</script>

